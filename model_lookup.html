<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Model Lookup</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0e0f11;
    --surface: #16181c;
    --border: #2a2d35;
    --accent: #e8c84a;
    --accent-dim: rgba(232,200,74,0.12);
    --text: #e2e4e9;
    --muted: #5a5f6e;
    --mono: 'Share Tech Mono', monospace;
    --sans: 'Barlow', sans-serif;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    background-image:
      repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(255,255,255,0.02) 39px, rgba(255,255,255,0.02) 40px),
      repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(255,255,255,0.02) 39px, rgba(255,255,255,0.02) 40px);
  }

  .card {
    width: 100%;
    max-width: 640px;
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 2.5rem;
    position: relative;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: var(--accent);
  }

  .label-row {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    margin-bottom: 0.5rem;
  }

  .tag {
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--accent);
    background: var(--accent-dim);
    border: 1px solid var(--accent);
    padding: 2px 6px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .back-btn {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--muted);
    background: none;
    border: none;
    cursor: pointer;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    transition: color 0.15s;
    padding: 0;
  }

  .back-btn:hover { color: var(--accent); }

  h1 {
    font-size: 1.6rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    color: var(--text);
    margin-bottom: 0.25rem;
  }

  .subtitle {
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 1rem;
    font-weight: 300;
  }

  .manufacturer-info {
    background: var(--bg);
    border: 1px solid var(--border);
    padding: 0.75rem 1rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .manufacturer-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--accent);
  }

  .manufacturer-id {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--muted);
  }

  .field-label {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
    display: block;
  }

  .input-wrap {
    position: relative;
  }

  input[type="text"] {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--sans);
    font-size: 1rem;
    font-weight: 600;
    padding: 0.85rem 2.5rem 0.85rem 1rem;
    outline: none;
    transition: border-color 0.15s;
    letter-spacing: 0.01em;
  }

  input[type="text"]:focus {
    border-color: var(--accent);
  }

  input[type="text"]::placeholder {
    color: var(--muted);
    font-weight: 300;
  }

  .clear-btn {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 1.1rem;
    line-height: 1;
    padding: 0;
    display: none;
    transition: color 0.15s;
  }

  .clear-btn:hover { color: var(--accent); }

  .dropdown {
    position: absolute;
    top: calc(100% + 2px);
    left: 0; right: 0;
    background: var(--surface);
    border: 1px solid var(--accent);
    border-top: none;
    max-height: 280px;
    overflow-y: auto;
    z-index: 100;
    display: none;
  }

  .dropdown::-webkit-scrollbar { width: 4px; }
  .dropdown::-webkit-scrollbar-track { background: var(--bg); }
  .dropdown::-webkit-scrollbar-thumb { background: var(--border); }

  .dropdown-item {
    padding: 0.65rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
  }

  .dropdown-item:last-child { border-bottom: none; }

  .dropdown-item:hover,
  .dropdown-item.active {
    background: var(--accent-dim);
  }

  .item-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 2px;
  }

  .item-name mark {
    background: none;
    color: var(--accent);
    font-weight: 700;
  }

  .item-meta {
    display: flex;
    gap: 1rem;
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--muted);
  }

  .no-results {
    padding: 1rem;
    font-size: 0.85rem;
    color: var(--muted);
    font-family: var(--mono);
  }

  .result-box {
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--bg);
    border: 1px solid var(--border);
    display: none;
  }

  .result-box.visible { display: block; }

  .result-label {
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 0.75rem;
  }

  .result-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }

  .result-item { display: flex; flex-direction: column; gap: 2px; }

  .result-key {
    font-family: var(--mono);
    font-size: 0.62rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .result-val {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text);
  }

  .result-val.accent { color: var(--accent); }
  .result-val.small { font-size: 0.75rem; }

  .submit-btn {
    margin-top: 1.5rem;
    width: 100%;
    background: var(--accent);
    color: #0e0f11;
    border: none;
    font-family: var(--mono);
    font-size: 0.8rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 0.9rem;
    cursor: pointer;
    font-weight: 700;
    transition: opacity 0.15s;
    display: none;
  }

  .submit-btn:hover { opacity: 0.85; }
  .submit-btn.visible { display: block; }

  .count-badge {
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--muted);
    text-align: right;
    margin-top: 0.4rem;
    letter-spacing: 0.05em;
  }

  .error-state {
    text-align: center;
    padding: 3rem 1rem;
  }

  .error-state h2 {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
    color: var(--muted);
  }

  .error-state p {
    color: var(--muted);
    margin-bottom: 1.5rem;
  }

  .error-btn {
    background: var(--accent);
    color: #0e0f11;
    border: none;
    font-family: var(--mono);
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    font-weight: 700;
    transition: opacity 0.15s;
  }

  .error-btn:hover { opacity: 0.85; }
</style>
</head>
<body>

<div class="card" id="main-card">
  <div class="label-row">
    <span class="tag">n8n trigger</span>
    <span class="tag">step 2/2</span>
    <button class="back-btn" id="back-btn">← back to manufacturers</button>
  </div>
  <h1>Model Lookup</h1>
  <p class="subtitle">Select a model for <span id="mfr-display"></span></p>

  <div class="manufacturer-info">
    <span class="manufacturer-name" id="selected-mfr">—</span>
    <span class="manufacturer-id" id="selected-mfr-id">—</span>
  </div>

  <label class="field-label" for="model-input">model name</label>
  <div class="input-wrap">
    <input
      type="text"
      id="model-input"
      placeholder="e.g. FOCUS, MUSTANG, F-150..."
      autocomplete="off"
      spellcheck="false"
    />
    <button class="clear-btn" id="clear-btn" title="Clear">✕</button>
    <div class="dropdown" id="dropdown"></div>
  </div>
  <div class="count-badge" id="count-badge"></div>

  <div class="result-box" id="result-box">
    <div class="result-label">selected model</div>
    <div class="result-grid">
      <div class="result-item">
        <span class="result-key">model name</span>
        <span class="result-val" id="res-name">—</span>
      </div>
      <div class="result-item">
        <span class="result-key">model id</span>
        <span class="result-val accent" id="res-id">—</span>
      </div>
      <div class="result-item">
        <span class="result-key">year from</span>
        <span class="result-val small" id="res-year-from">—</span>
      </div>
      <div class="result-item">
        <span class="result-key">year to</span>
        <span class="result-val small" id="res-year-to">—</span>
      </div>
    </div>
  </div>

  <button class="submit-btn" id="submit-btn">
    ▶ &nbsp; Continue Workflow
  </button>
</div>

<script>
// Load data from sessionStorage
const storedData = sessionStorage.getItem('manufacturerData');

if (!storedData) {
  document.getElementById('main-card').innerHTML = `
    <div class="error-state">
      <h2>No Data Found</h2>
      <p>Please start by selecting a manufacturer first.</p>
      <button class="error-btn" onclick="window.location.href='index.html'">Go to Manufacturer Lookup</button>
    </div>
  `;
} else {
  const data = JSON.parse(storedData);
  const manufacturer = data.manufacturer;
  const models = data.models || [];

  console.log('Loaded data:', data);
  console.log('Models count:', models.length);

  // Display manufacturer info
  document.getElementById('mfr-display').textContent = manufacturer.manufacturerName;
  document.getElementById('selected-mfr').textContent = manufacturer.manufacturerName;
  document.getElementById('selected-mfr-id').textContent = `#${manufacturer.manufacturerId}`;

  const input = document.getElementById('model-input');
  const dropdown = document.getElementById('dropdown');
  const clearBtn = document.getElementById('clear-btn');
  const resultBox = document.getElementById('result-box');
  const resName = document.getElementById('res-name');
  const resId = document.getElementById('res-id');
  const resYearFrom = document.getElementById('res-year-from');
  const resYearTo = document.getElementById('res-year-to');
  const submitBtn = document.getElementById('submit-btn');
  const countBadge = document.getElementById('count-badge');
  const backBtn = document.getElementById('back-btn');

  window.selectedModel = null;
  let activeIndex = -1;

  function formatDate(dateStr) {
    if (!dateStr) return 'Present';
    const date = new Date(dateStr);
    return date.getFullYear();
  }

  function highlight(text, query) {
    const idx = text.toLowerCase().indexOf(query.toLowerCase());
    if (idx === -1) return text;
    return text.slice(0, idx) + '<mark>' + text.slice(idx, idx + query.length) + '</mark>' + text.slice(idx + query.length);
  }

  function showDropdown(query) {
    const q = query.trim();
    if (q.length === 0) { closeDropdown(); return; }

    const matches = models.filter(m =>
      m.modelName.toLowerCase().includes(q.toLowerCase())
    ).slice(0, 50);

    countBadge.textContent = matches.length > 0 ? `${matches.length} match${matches.length !== 1 ? 'es' : ''}` : '';

    if (matches.length === 0) {
      dropdown.innerHTML = `<div class="no-results">// no matches found</div>`;
    } else {
      dropdown.innerHTML = matches.map((m, i) => `
        <div class="dropdown-item" data-index="${i}" data-id="${m.modelId}" data-name="${m.modelName}" data-year-from="${m.modelYearFrom || ''}" data-year-to="${m.modelYearTo || ''}">
          <div class="item-name">${highlight(m.modelName, q)}</div>
          <div class="item-meta">
            <span>#${m.modelId}</span>
            <span>${formatDate(m.modelYearFrom)} - ${formatDate(m.modelYearTo)}</span>
          </div>
        </div>
      `).join('');

      dropdown.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('mousedown', (e) => {
          e.preventDefault();
          selectItem(
            item.dataset.name,
            parseInt(item.dataset.id),
            item.dataset.yearFrom,
            item.dataset.yearTo
          );
        });
      });
    }

    dropdown.style.display = 'block';
    activeIndex = -1;
  }

  function closeDropdown() {
    dropdown.style.display = 'none';
    activeIndex = -1;
  }

  function selectItem(name, id, yearFrom, yearTo) {
    window.selectedModel = {
      modelName: name,
      modelId: id,
      modelYearFrom: yearFrom,
      modelYearTo: yearTo
    };
    
    input.value = name;
    clearBtn.style.display = 'block';
    closeDropdown();
    countBadge.textContent = '';

    resName.textContent = name;
    resId.textContent = id;
    resYearFrom.textContent = formatDate(yearFrom);
    resYearTo.textContent = formatDate(yearTo);
    resultBox.classList.add('visible');
    submitBtn.classList.add('visible');
    
    console.log('Selected model:', window.selectedModel);
  }

  function clearSelection() {
    window.selectedModel = null;
    input.value = '';
    clearBtn.style.display = 'none';
    resultBox.classList.remove('visible');
    submitBtn.classList.remove('visible');
    countBadge.textContent = '';
    closeDropdown();
    input.focus();
  }

  input.addEventListener('input', () => {
    window.selectedModel = null;
    resultBox.classList.remove('visible');
    submitBtn.classList.remove('visible');
    clearBtn.style.display = input.value.length > 0 ? 'block' : 'none';
    showDropdown(input.value);
  });

  input.addEventListener('keydown', (e) => {
    const items = dropdown.querySelectorAll('.dropdown-item');
    if (!items.length) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      activeIndex = Math.min(activeIndex + 1, items.length - 1);
      items.forEach((el, i) => el.classList.toggle('active', i === activeIndex));
      items[activeIndex]?.scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      activeIndex = Math.max(activeIndex - 1, 0);
      items.forEach((el, i) => el.classList.toggle('active', i === activeIndex));
      items[activeIndex]?.scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (activeIndex >= 0 && items[activeIndex]) {
        const item = items[activeIndex];
        selectItem(
          item.dataset.name,
          parseInt(item.dataset.id),
          item.dataset.yearFrom,
          item.dataset.yearTo
        );
      }
    } else if (e.key === 'Escape') {
      closeDropdown();
    }
  });

  input.addEventListener('blur', () => setTimeout(closeDropdown, 150));
  clearBtn.addEventListener('click', clearSelection);
  backBtn.addEventListener('click', () => {
    sessionStorage.removeItem('manufacturerData');
    window.location.href = 'index.html';
  });

  submitBtn.addEventListener('click', async () => {
    console.log('Submit clicked! selectedModel:', window.selectedModel);
    
    if (!window.selectedModel) {
      console.log('No model selected');
      return;
    }
    
    submitBtn.textContent = '⏳  SENDING...';
    submitBtn.style.opacity = '0.6';
    
    const payload = {
      manufacturerId: manufacturer.manufacturerId,
      manufacturerName: manufacturer.manufacturerName,
      modelId: window.selectedModel.modelId,
      modelName: window.selectedModel.modelName,
      modelYearFrom: window.selectedModel.modelYearFrom,
      modelYearTo: window.selectedModel.modelYearTo,
      timestamp: new Date().toISOString()
    };
    
    console.log('Sending final payload:', payload);
    
    try {
      const response = await fetch('https://aretech.app.n8n.cloud/webhook/model-selected', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      console.log('Response status:', response.status);
      
      if (response.ok) {
        submitBtn.textContent = '✓  COMPLETE';
        setTimeout(() => {
          // Clear data and go back to start
          sessionStorage.removeItem('manufacturerData');
          window.location.href = 'index.html';
        }, 1500);
      } else {
        throw new Error('Failed');
      }
    } catch (error) {
      console.error('Fetch error:', error);
      submitBtn.textContent = '✗  FAILED';
      submitBtn.style.opacity = '1';
      setTimeout(() => {
        submitBtn.textContent = '▶  CONTINUE WORKFLOW';
      }, 2000);
    }
  });

  console.log('Model lookup loaded successfully');
}
</script>
</body>
</html>
